<!DOCTYPE html>
<head>
<meta charset="utf-8">
<title>Simple Bar Chart</title>
<script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>
<style>
    
body { 
    font: 12px "Helvetica", "Arial", "Sans-Serif";
    color: #999;
}

path { 
    stroke: #999;
    stroke-width: 3;
    fill: none;
}

.axis path,
.axis line {
    fill: none;
    stroke: grey;
    stroke-width: 1;
    shape-rendering: crispEdges;
}

.legend {
    font-size: 20px;
    font-weight: bold;
}
    
</style>
</head>
<body>
<script>

var selectedData = "confirmed";

// Set the dimensions of the canvas / graph
var margin = {top: 100, right: 300, bottom: 100, left: 100},
    width = 1400 - margin.left - margin.right,
    height = 1000 - margin.top - margin.bottom;

// Parse the date / time
var parseDate = d3.timeParse("%Y%m%d");

// Set the ranges
var x = d3.scaleTime().range([0, width]);  
var y = d3.scaleSqrt().range([height, 0]);
var y = d3.scaleLinear().range([height, 0]);

// Define the line
var line = d3.line()	
    .x(function(d) { return x(d.date); })
    .y(function(d) { return y(d[selectedData]); });
    
// Adds the svg canvas
var svg = d3.select("body")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


function render(data){

    data = data.filter(function(row) {
        return row['label_parent_en'] === 'null'
            && (row['label_en'] === 'USA'
            || row['label_en'] === 'Spain'
            || row['label_en'] === 'Italy'
            || row['label_en'] === 'Germany'
            || row['label_en'] === 'United Kingdom'
            || row['label_en'] === 'France'
            || row['label_en'] === 'Turkey'
            || row['label_en'] === 'Iran'
            || row['label_en'] === 'Russia'
            || row['label_en'] === 'Canada');
    });

    data.forEach(function(d) {
		d.date = parseDate(d.date);
		d[selectedData] = +d[selectedData];
    });

    var max = function(data){
        return d3.max(data, function(d) { return d[selectedData]; })
    }

    // Scale the range of the data
    x.domain(d3.extent(data, function(d) { return d.date; }));
    y.domain([0, max(data)]);

    // set the colour scale
    var color = d3.scaleOrdinal(d3.schemeCategory10);

    // Nest the entries by country
    var dataNest = d3.nest()
        .key(function(d) {return d.label_en;})
        .entries(data);

    dataNest.sort(function (a, b){
        console.log(a, b)
        if (max(a.values) > max(b.values)) {return -1;} 
        else if (max(a.values) < max(b.values)) { return 1;} 
        else return 0;
    })

    legendSpace = height/dataNest.length;

    // Loop through each symbol / key
    dataNest.forEach(function(d,i) { 
        svg.append("path")
            .attr("class", "line")
            .style("stroke", function() {
                return d.color = color(d.key); })
            .attr("d", line(d.values));

        // Add the Legend
        svg.append("text")
            .attr("y", (legendSpace/2)+i*legendSpace)  
            .attr("x", width + 50)
            .attr("class", "legend")
            .style("fill", function() {
                return d.color = color(d.key); })
            .text(d.key); 

    });

  // Add the X Axis
  svg.append("g")
      .attr("class", "axis")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x));

  // Add the Y Axis
  svg.append("g")
      .attr("class", "axis")
      .call(d3.axisLeft(y));

}

// Get the data
d3.csv("data/historical.csv").then(function(data) {
    render(data)
});

</script>
</body>